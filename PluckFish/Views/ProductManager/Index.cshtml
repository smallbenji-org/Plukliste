@model PluckFish.Controllers.ProductViewModel
@{
    ViewData["Title"] = "Produktstyring";
}

<div class="card">
    <h2>Tilføj nyt produkt</h2>
    <form asp-action="Index" method="post" class="add-product-form">
        <div class="form-group">
            <label class="label" for="prodName">Produktnavn:</label>
            <input class="list-dropdown" id="prodName" name="prodName" />
            <span class="text-danger"></span>
        </div>
        <div class="form-group">
            <label class="label" for="prodID">Produkt ID:</label>
            <input class="list-dropdown" id="prodID" name="prodID" />
            <span class="text-danger"></span>
        </div>
        <div class="form-group">
            <input type="submit" value="Tilføj Produkt" class="confirm-btn" />
        </div>
    </form>
</div>

<div class="card">
    <h2>Eksisterende Produkter</h2>
    <div class="row2">
        <div class="form-group search-container wide" style="margin-bottom: 1rem;">
            <form id="searchForm" method="post" asp-action="GetProductTable">
                <input type="text" name="searchText" id="searchBox" class="form-control" placeholder="Søg Varer...">
            </form>
            <div class="search-icon">
                <svg data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"></path>
                </svg>
            </div>
        </div>

        <form asp-action="ImportProduct" enctype="multipart/form-data" method="post" class="card-button twenty-percent h-1" id="uploadForm">
            <label for="fileInput" class="create-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-plus"><path stroke="none" d="M0 0h24v24H0z" fill="none" /><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
                Importer produkter
            </label>
            <input type="file" id="fileInput" name="file" required style="display: none;" />
        </form>
    </div>

    <div id="product-table-container">
        @await Html.PartialAsync("~/Views/ProductManager/_ProductTablePartial.cshtml", Model)
    </div>
</div>

<script>
    const tableContainer = document.getElementById("product-table-container");

    async function loadTable(url) {
        try {
            const searchText = document.getElementById("searchBox").value;
            const response = await fetch(url+"&searchText=" + encodeURIComponent(searchText));
            const html = await response.text();
            tableContainer.innerHTML = html;
            window.history.pushState({ path: url }, '', url.replace('GetProductTable', 'ScrollPage'));
        } catch (error) {
            console.error('Failed to load table content:', error);
        }
    }

    tableContainer.addEventListener("click", function (e) {
        if (e.target.closest('.pagination a')) {
            e.preventDefault();
            const link = e.target.closest('.pagination a');
            loadTable(link.href);
        }
    });

    document.getElementById("fileInput").addEventListener("change", function () {
        if (this.value) {
            document.getElementById("uploadForm").submit();
        }
    });

    document.getElementById("searchForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const url = this.action + "?nextPage=1";
        loadTable(url);
    });
</script>