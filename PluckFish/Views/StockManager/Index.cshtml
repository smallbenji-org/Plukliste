@model PluckFish.Controllers.StockViewModel;
@{
    ViewData["Title"] = "Lagersystem";
}

<main>
    <div class="card">
        <div class="area">
            @{
                var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
            }

            <div class="sort-options">
                <form asp-action="Index">
                    <button class="sort-btn @(currentAction == "Index" ? "active" : "")">Alle Varer</button>
                </form>
                <form asp-action="VisRestVare">
                    <button class="sort-btn @(currentAction == "VisRestVare" ? "active" : "")">Vis kun rest vare</button>
                </form>
                <form asp-action="VisVare">
                    <button class="sort-btn @(currentAction == "VisVare" ? "active" : "")">Vis kun ikke rest vare</button>
                </form>
            </div>
        </div>
        <div class="table-responsive">
            <table class="vare-table">
                <thead>
                    <tr>
                        <th>Produkt Id</th>
                        <th>Produkt navn</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Rest vare</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (Item item in Model.stockInventory)
                    {
                        <tr>
                            <td data-label="Produkt Id">@item.Product.ProductID</td>
                            <td data-label="Produkt navn">@item.Product.Name</td>
                            <td data-label="Type">@item.Type</td>
                            <td data-label="Amount">@item.Amount</td>
                            <td class="checkbox-cell" data-label="Rest vare">
                                @if (item.RestVare)
                                {
                                    <input type="checkbox" class="form-checkbox" checked onclick="return false" />
                                }
                                else
                                {
                                    <input type="checkbox" class="form-checkbox" onclick="return false" />
                                }
                            <td data-label="Rediger">
                                <button type="button" class="edit-btn" data-productid="@item.Product.ProductID" data-amount="@item.Amount" data-restvare=@item.RestVare>Rediger</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <form asp-action="ScrollPage" method="get">
                <input type="hidden" name="nextPage" value="@(Model.currentPage+1)" />
                <input type="hidden" name="filter" value="@Model.filter" />

                <button type="submit" class="sort-btn @(currentAction == "VisRestVare" ? "active" : "")">
                    Næste Page
                </button>
            </form>
            
            <form asp-action="ScrollPage" method="get">
                <input type="hidden" name="nextPage" value="@(Model.currentPage-1)" />
                <input type="hidden" name="filter" value="@Model.filter" />

                <button type="submit" class="sort-btn @(currentAction == "VisRestVare" ? "active" : "")">
                    Forrige Page
                </button>
            </form>

        </div>
    </div>

    <div class="card" id="tomForm">
        <h2>Rediger vare</h2>
        <p class="edit-placeholder">Vælg en vare fra listen for at redigere.</p>
    </div>

    <div class="card hidden" id="redigerForm">
        <h2 id="redigerTitel">Rediger vare ()</h2>
        <form class="edit-form" method="post" action="/StockManager/Result">
            <div class="form-group">
                <label for="vare-maengde">Vare mængde</label>
                <input type="number" id="vare-maengde" class="form-control" value="1" min="0">
            </div>
            <div class="form-group-inline">
                <input type="checkbox" id="rest-vare" class="form-checkbox">
                <label for="rest-vare">Rest vare</label>
            </div>
            <button type="submit" class="confirm-btn">Gem ændringer</button>
        </form>
    </div>


    <script>
        const editButtons = document.querySelectorAll(".edit-btn");
        const redigerFormContainer = document.getElementById("redigerForm");
        const redigerForm = redigerFormContainer.querySelector("form");
        const redigerFormTitel = document.getElementById("redigerTitel");
        const tomForm = document.getElementById("tomForm");

        editButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const productId = btn.dataset.productid;
                const amount = btn.dataset.amount;
                const restVare = btn.dataset.restvare;

                redigerFormContainer.dataset.productId = productId;
                vareForm = document.getElementById("vare-maengde").value = amount;

                const checkbox = document.getElementById("rest-vare");
                if (restVare == "True"){
                    checkbox.checked = true;
                }else{
                    checkbox.checked = false;
                }

                tomForm.classList.add("hidden");
                redigerFormTitel.innerText = "Rediger vare ("+productId+")";
                redigerFormContainer.classList.remove("hidden");

                redigerFormTitel.scrollIntoView({ behavior: 'smooth' });
            });
        });

        redigerForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const productId = redigerFormContainer.dataset.productId;

            const formData = new FormData(redigerForm);
            formData.append("prodId", productId);
            const vareForm = document.getElementById("vare-maengde");
            formData.append("amount", vareForm.value);
            const checkbox = document.getElementById("rest-vare");
            formData.append("restVare", checkbox.checked);

            const response = await fetch(redigerForm.action, {
                method: redigerForm.method,
                body: formData
            });

            if (response.ok) {
                window.location.href = "/StockManager/Index";
            }
            });
    </script>
</main>
